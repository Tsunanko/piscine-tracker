<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Piscine Tracker</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #0e0e16;
      --surface:   #14141f;
      --surface2:  #1a1a28;
      --border:    #2a2a3a;
      --accent:    #6c5ce7;
      --accent2:   #a29bfe;
      --green:     #00cec9;
      --orange:    #fdcb6e;
      --red:       #ff7675;
      --text:      #e8e8f0;
      --text-dim:  #8888a0;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: "Noto Sans JP", system-ui, -apple-system, sans-serif;
      min-height: 100dvh;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px 16px 60px;
    }

    /* â”€â”€â”€ Header â”€â”€â”€ */
    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 20px 0 24px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 24px;
    }
    .header-icon { font-size: 28px; }
    .header-title {
      font-size: 20px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent), var(--green));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .header-sub { font-size: 12px; color: var(--text-dim); margin-top: 2px; }
    .back-link {
      margin-left: auto;
      color: var(--accent2);
      text-decoration: none;
      font-size: 13px;
    }
    .back-link:hover { text-decoration: underline; }

    /* â”€â”€â”€ Stats bar â”€â”€â”€ */
    .stats-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .stat-chip {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 18px;
      text-align: center;
    }
    .stat-chip-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
    .stat-chip-value { font-size: 22px; font-weight: 800; margin-top: 2px; }
    .stat-chip-value.accent { color: var(--accent2); }
    .stat-chip-value.green  { color: var(--green); }
    .stat-chip-value.orange { color: var(--orange); }

    /* â”€â”€â”€ Tabs â”€â”€â”€ */
    .tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 16px;
    }
    .tab-btn {
      padding: 8px 18px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-dim);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .tab-btn.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    /* â”€â”€â”€ Search â”€â”€â”€ */
    .search-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .table-search {
      flex: 1;
      padding: 9px 14px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 13px;
      outline: none;
      transition: border-color 0.15s;
    }
    .table-search:focus { border-color: var(--accent); }
    .table-search::placeholder { color: var(--text-dim); }

    /* â”€â”€â”€ Table â”€â”€â”€ */
    .table-wrap {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .data-table th {
      background: var(--surface2);
      color: var(--text-dim);
      padding: 10px 14px;
      text-align: left;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      white-space: nowrap;
    }
    .data-table td {
      padding: 9px 14px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }
    .data-table tr:last-child td { border-bottom: none; }
    .data-table tr:hover td { background: rgba(108,92,231,0.05); }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }
    .badge-oauth  { background: rgba(0,206,201,0.15); color: var(--green); }
    .badge-simple { background: rgba(253,203,110,0.15); color: var(--orange); }

    .login-name {
      font-weight: 700;
      color: var(--accent2);
    }

    .ip-text { font-family: monospace; color: var(--text-dim); font-size: 12px; }
    .ua-text { color: var(--text-dim); font-size: 11px; max-width: 280px;
               overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .ts-text  { font-family: monospace; font-size: 12px; color: var(--text-dim); white-space: nowrap; }

    .empty-msg {
      padding: 40px;
      text-align: center;
      color: var(--text-dim);
      font-size: 14px;
    }

    /* â”€â”€â”€ Error / Loading â”€â”€â”€ */
    .msg-box {
      padding: 20px;
      border-radius: 12px;
      font-size: 14px;
      margin-bottom: 16px;
    }
    .msg-error   { background: rgba(255,118,117,0.1); border: 1px solid rgba(255,118,117,0.3); color: var(--red); }
    .msg-loading { background: rgba(108,92,231,0.1); border: 1px solid rgba(108,92,231,0.3); color: var(--accent2); }

    .spinner {
      display: inline-block;
      width: 16px; height: 16px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      vertical-align: middle;
      margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€â”€ Refresh btn â”€â”€â”€ */
    .btn-refresh {
      padding: 9px 16px;
      background: transparent;
      color: var(--accent2);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      transition: border-color 0.15s, color 0.15s;
    }
    .btn-refresh:hover { border-color: var(--accent); color: var(--accent); }
  </style>
</head>
<body>

<div class="container">
  <!-- Header -->
  <div class="header">
    <div class="header-icon">ğŸ”</div>
    <div>
      <div class="header-title">Admin Panel</div>
      <div class="header-sub">Piscine Tracker Â· ç®¡ç†è€…å°‚ç”¨</div>
    </div>
    <a href="dashboard.html" class="back-link">â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸</a>
  </div>

  <!-- Stats bar -->
  <div class="stats-bar" id="statsBar" style="display:none">
    <div class="stat-chip">
      <div class="stat-chip-label">ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´</div>
      <div class="stat-chip-value accent" id="statLogs">-</div>
    </div>
    <div class="stat-chip">
      <div class="stat-chip-label">42 OAuth</div>
      <div class="stat-chip-value green" id="statOauth">-</div>
    </div>
    <div class="stat-chip">
      <div class="stat-chip-label">åˆè¨€è‘‰ãƒ­ã‚°ã‚¤ãƒ³</div>
      <div class="stat-chip-value orange" id="statSimple">-</div>
    </div>
    <div class="stat-chip">
      <div class="stat-chip-label">åŒæ„æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶</div>
      <div class="stat-chip-value accent" id="statConsents">-</div>
    </div>
  </div>

  <!-- Message area -->
  <div id="msgArea"></div>

  <!-- Tabs -->
  <div class="tabs" id="tabsArea" style="display:none">
    <button class="tab-btn active" onclick="showTab('logs')" id="tabLogs">ğŸ“‹ ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´</button>
    <button class="tab-btn" onclick="showTab('consents')" id="tabConsents">âœ… åŒæ„è¨˜éŒ²</button>
  </div>

  <!-- Search + Refresh row -->
  <div class="search-row" id="searchRow" style="display:none">
    <input type="text" class="table-search" id="tableSearch"
      placeholder="ãƒ­ã‚°ã‚¤ãƒ³åã§æ¤œç´¢..."
      oninput="renderTable()" />
    <button class="btn-refresh" onclick="loadAll()">ğŸ”„ æ›´æ–°</button>
  </div>

  <!-- Table area -->
  <div id="tableArea"></div>
</div>

<script>
  const WORKER = 'https://piscine-tracker.tsunanko.workers.dev';

  let allLogs     = [];
  let allConsents = [];
  let currentTab  = 'logs';

  // â”€â”€â”€ èªè¨¼ã‚¬ãƒ¼ãƒ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ijoja ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
  const token    = sessionStorage.getItem('piscine_42_token');
  const userJson = sessionStorage.getItem('piscine_42_user');
  if (!token) {
    window.location.replace('login.html');
  } else {
    try {
      const u = JSON.parse(userJson);
      if (u.login !== 'ijoja') {
        window.location.replace('dashboard.html');
      }
    } catch {
      window.location.replace('login.html');
    }
  }

  // â”€â”€â”€ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãƒˆãƒ¼ã‚¯ãƒ³ã§è‡ªå‹•èªè¨¼ï¼‰â”€â”€â”€â”€
  async function loadAll() {
    showMsg('<span class="spinner"></span>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...', 'loading');

    const authHeader = { 'Authorization': `Bearer ${token}` };

    try {
      const [logsRes, consentsRes] = await Promise.all([
        fetch(`${WORKER}/api/logs`,     { headers: authHeader }),
        fetch(`${WORKER}/api/consents`, { headers: authHeader }),
      ]);

      if (logsRes.status === 401 || consentsRes.status === 401) {
        showMsg('âŒ èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
      }
      if (!logsRes.ok || !consentsRes.ok) {
        throw new Error('API error');
      }

      allLogs     = await logsRes.json();
      allConsents = await consentsRes.json();

      clearMsg();
      updateStats();
      showControls();
      renderTable();

    } catch (e) {
      showMsg('âŒ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'error');
    }
  }

  // â”€â”€â”€ çµ±è¨ˆæ›´æ–° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateStats() {
    const oauthCount  = allLogs.filter(l => l.method === 'oauth').length;
    const simpleCount = allLogs.filter(l => l.method === 'simple').length;
    document.getElementById('statLogs').textContent    = allLogs.length;
    document.getElementById('statOauth').textContent   = oauthCount;
    document.getElementById('statSimple').textContent  = simpleCount;
    document.getElementById('statConsents').textContent = allConsents.length;
    document.getElementById('statsBar').style.display = 'flex';
  }

  // â”€â”€â”€ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡¨ç¤º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showControls() {
    document.getElementById('tabsArea').style.display  = 'flex';
    document.getElementById('searchRow').style.display = 'flex';
  }

  // â”€â”€â”€ ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showTab(tab) {
    currentTab = tab;
    document.getElementById('tabLogs').classList.toggle('active', tab === 'logs');
    document.getElementById('tabConsents').classList.toggle('active', tab === 'consents');
    const ph = tab === 'logs' ? 'ãƒ­ã‚°ã‚¤ãƒ³åãƒ»IPã§æ¤œç´¢...' : 'ãƒ­ã‚°ã‚¤ãƒ³åã§æ¤œç´¢...';
    document.getElementById('tableSearch').placeholder = ph;
    renderTable();
  }

  // â”€â”€â”€ ãƒ†ãƒ¼ãƒ–ãƒ«æç”» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderTable() {
    const q = document.getElementById('tableSearch').value.trim().toLowerCase();

    if (currentTab === 'logs') {
      renderLogs(q);
    } else {
      renderConsents(q);
    }
  }

  function renderLogs(q) {
    const filtered = q
      ? allLogs.filter(l => l.login.toLowerCase().includes(q) || (l.ip || '').includes(q))
      : allLogs;

    if (filtered.length === 0) {
      document.getElementById('tableArea').innerHTML = `<div class="table-wrap"><div class="empty-msg">è©²å½“ã™ã‚‹ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</div></div>`;
      return;
    }

    const rows = filtered.map(e => `
      <tr>
        <td class="ts-text">${e.ts || '-'}</td>
        <td class="login-name">${esc(e.login)}</td>
        <td>
          <span class="badge badge-${e.method}">
            ${e.method === 'oauth' ? 'ğŸ”‘ 42 OAuth' : 'ğŸ” åˆè¨€è‘‰'}
          </span>
        </td>
        <td class="ip-text">${esc(e.ip || '-')}</td>
        <td><div class="ua-text" title="${esc(e.ua || '')}">${esc(e.ua || '-')}</div></td>
      </tr>
    `).join('');

    document.getElementById('tableArea').innerHTML = `
      <div class="table-wrap">
        <table class="data-table">
          <thead>
            <tr>
              <th>æ—¥æ™‚ (JST)</th>
              <th>ãƒ­ã‚°ã‚¤ãƒ³å</th>
              <th>æ–¹æ³•</th>
              <th>IPã‚¢ãƒ‰ãƒ¬ã‚¹</th>
              <th>User Agent</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
      <div style="margin-top:10px;font-size:11px;color:var(--text-dim);text-align:right">
        ${filtered.length} / ${allLogs.length} ä»¶è¡¨ç¤º
      </div>
    `;
  }

  function renderConsents(q) {
    const filtered = q
      ? allConsents.filter(c => c.login.toLowerCase().includes(q))
      : allConsents;

    if (filtered.length === 0) {
      document.getElementById('tableArea').innerHTML = `<div class="table-wrap"><div class="empty-msg">è©²å½“ã™ã‚‹åŒæ„è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div></div>`;
      return;
    }

    const rows = filtered.map(e => {
      // consentedAt ã¯ISOæ–‡å­—åˆ— â†’ JSTè¡¨ç¤º
      let consentedAtJst = '-';
      if (e.consentedAt) {
        try {
          consentedAtJst = new Date(e.consentedAt).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
        } catch {}
      }
      return `
        <tr>
          <td class="login-name">${esc(e.login)}</td>
          <td>
            <span class="badge badge-${e.method}">
              ${e.method === 'oauth' ? 'ğŸ”‘ 42 OAuth' : 'ğŸ” åˆè¨€è‘‰'}
            </span>
          </td>
          <td class="ts-text">${consentedAtJst}</td>
          <td class="ip-text">${esc(e.ip || '-')}</td>
        </tr>
      `;
    }).join('');

    document.getElementById('tableArea').innerHTML = `
      <div class="table-wrap">
        <table class="data-table">
          <thead>
            <tr>
              <th>ãƒ­ã‚°ã‚¤ãƒ³å</th>
              <th>ãƒ­ã‚°ã‚¤ãƒ³æ–¹æ³•</th>
              <th>åŒæ„æ—¥æ™‚ (JST)</th>
              <th>IPã‚¢ãƒ‰ãƒ¬ã‚¹</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
      <div style="margin-top:10px;font-size:11px;color:var(--text-dim);text-align:right">
        ${filtered.length} / ${allConsents.length} ä»¶è¡¨ç¤º
      </div>
    `;
  }

  // â”€â”€â”€ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showMsg(html, type) {
    document.getElementById('msgArea').innerHTML =
      `<div class="msg-box msg-${type}">${html}</div>`;
  }
  function clearMsg() {
    document.getElementById('msgArea').innerHTML = '';
  }

  // â”€â”€â”€ XSSå¯¾ç­– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function esc(str) {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }

  // â”€â”€â”€ ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã«è‡ªå‹•èª­ã¿è¾¼ã¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  loadAll();
</script>
</body>
</html>
