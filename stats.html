<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>çµ±è¨ˆåˆ†æ - Piscine Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #0f0f14;
    --surface: #1a1a24;
    --surface2: #22222e;
    --border: #2a2a3a;
    --text: #e8e8f0;
    --text-dim: #8888a0;
    --accent: #6c5ce7;
    --accent-light: #a29bfe;
    --green: #00cec9;
    --green-dim: #00b8941a;
    --red: #ff7675;
    --red-dim: #ff76751a;
    --orange: #fdcb6e;
    --gradient: linear-gradient(135deg, #6c5ce7, #00cec9);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }

  .container {
    max-width: 760px;
    margin: 0 auto;
    padding: 16px;
  }

  /* â”€â”€ ãƒ˜ãƒƒãƒ€ãƒ¼ â”€â”€ */
  .header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 0 20px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 20px;
  }
  .back-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 13px;
    cursor: pointer;
    text-decoration: none;
    transition: color 0.15s, border-color 0.15s;
  }
  .back-btn:hover { color: var(--text); border-color: var(--accent); }
  .header-title {
    font-size: 18px;
    font-weight: 700;
    background: var(--gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .header-sub {
    margin-left: auto;
    font-size: 12px;
    color: var(--text-dim);
  }

  /* â”€â”€ ã‚¿ãƒ– â”€â”€ */
  .tab-bar {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .tab-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .tab-btn:hover { border-color: var(--accent); color: var(--text); }
  .tab-btn.active {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
    font-weight: 600;
  }

  /* â”€â”€ æ¤œç´¢ãƒãƒ¼ â”€â”€ */
  .search-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
  }
  .search-input {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-size: 13px;
    padding: 8px 14px;
    outline: none;
    transition: border-color 0.15s;
  }
  .search-input:focus { border-color: var(--accent); }
  .search-input::placeholder { color: var(--text-dim); }
  .search-clear {
    background: none;
    border: none;
    color: var(--text-dim);
    font-size: 18px;
    cursor: pointer;
    padding: 4px 6px;
    line-height: 1;
    transition: color 0.15s;
    display: none;
  }
  .search-clear:hover { color: var(--red); }
  .search-result {
    font-size: 12px;
    color: var(--text-dim);
    white-space: nowrap;
    min-width: 100px;
  }
  .search-result.found { color: var(--red); font-weight: 600; }

  /* â”€â”€ ç›¸é–¢ã‚«ãƒ¼ãƒ‰ â”€â”€ */
  .corr-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 16px;
  }
  .corr-header {
    display: flex;
    align-items: baseline;
    gap: 12px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .corr-title {
    font-size: 15px;
    font-weight: 700;
    color: var(--text);
  }
  .r-badge {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .r-value {
    font-size: 24px;
    font-weight: 800;
    font-variant-numeric: tabular-nums;
  }
  .r-interp {
    font-size: 12px;
    font-weight: 600;
    padding: 3px 10px;
    border-radius: 10px;
  }

  /* â”€â”€ å¹³å‡ç·šã®å‡¡ä¾‹ â”€â”€ */
  .mean-legend {
    display: flex;
    gap: 16px;
    margin-top: 8px;
    font-size: 11px;
    color: var(--text-dim);
    flex-wrap: wrap;
  }
  .mean-legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .mean-line-sample {
    width: 20px;
    height: 2px;
    border-top: 2px dashed;
    flex-shrink: 0;
  }

  .chart-wrap {
    position: relative;
    height: 360px;
  }

  /* â”€â”€ ã‚µãƒãƒªãƒ¼è¡Œ â”€â”€ */
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-top: 16px;
  }
  @media (max-width: 500px) {
    .summary-grid { grid-template-columns: repeat(2, 1fr); }
  }
  .summary-item {
    background: var(--surface2);
    border-radius: 10px;
    padding: 10px 12px;
    text-align: center;
  }
  .summary-label {
    font-size: 10px;
    color: var(--text-dim);
    margin-bottom: 4px;
  }
  .summary-value {
    font-size: 15px;
    font-weight: 700;
    color: var(--accent-light);
  }
  .summary-value.highlight-x { color: var(--orange); }
  .summary-value.highlight-y { color: var(--green); }

  /* â”€â”€ å…¨ãƒšã‚¢ã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ« â”€â”€ */
  .all-corr {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
  }
  .all-corr-title {
    font-weight: 700;
    color: var(--text-dim);
    margin-bottom: 12px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    font-size: 11px;
  }
  .corr-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  .corr-table th {
    text-align: left;
    color: var(--text-dim);
    font-weight: 600;
    font-size: 11px;
    padding: 6px 8px;
    border-bottom: 1px solid var(--border);
  }
  .corr-table td {
    padding: 8px 8px;
    border-bottom: 1px solid var(--border);
  }
  .corr-table tr:last-child td { border-bottom: none; }
  .corr-table tr { cursor: pointer; transition: background 0.1s; }
  .corr-table tr:hover td { background: var(--surface2); }

  .loading {
    text-align: center;
    color: var(--text-dim);
    padding: 60px 0;
    font-size: 14px;
  }

  /* pass/fail å‡¡ä¾‹ */
  .legend {
    display: flex;
    gap: 16px;
    margin-top: 10px;
    font-size: 12px;
    color: var(--text-dim);
  }
  .legend-dot {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 4px;
    vertical-align: middle;
  }
</style>
</head>
<body>
<div class="container">

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <a href="dashboard.html" class="back-btn">â† Dashboard</a>
    <div class="header-title">ğŸ“Š çµ±è¨ˆåˆ†æ</div>
    <div class="header-sub" id="headerSub">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

  <!-- ã‚¿ãƒ– -->
  <div class="tab-bar">
    <button class="tab-btn active" onclick="switchTab(0)">æ™‚é–“ Ã— Level</button>
    <button class="tab-btn" onclick="switchTab(1)">æ™‚é–“ Ã— ãƒ¬ãƒ“ãƒ¥ãƒ¼å›æ•°</button>
    <button class="tab-btn" onclick="switchTab(2)">Level Ã— ãƒ¬ãƒ“ãƒ¥ãƒ¼å›æ•°</button>
  </div>

  <!-- æ¤œç´¢ãƒãƒ¼ -->
  <div class="search-bar">
    <input type="text" class="search-input" id="searchInput"
      placeholder="ãƒ­ã‚°ã‚¤ãƒ³åã§æ¤œç´¢ã—ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆ... (ä¾‹: yuichika)"
      oninput="onSearch(this.value)" />
    <button class="search-clear" id="searchClear" onclick="clearSearch()">âœ•</button>
    <div class="search-result" id="searchResult"></div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ -->
  <div class="corr-card" id="mainCard">
    <div class="loading">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

  <!-- å…¨ãƒšã‚¢ç›¸é–¢ã‚µãƒãƒªãƒ¼ -->
  <div class="all-corr" id="allCorrTable" style="display:none">
    <div class="all-corr-title">ç›¸é–¢ä¿‚æ•°ã¾ã¨ã‚</div>
    <table class="corr-table">
      <thead>
        <tr>
          <th>æŒ‡æ¨™ãƒšã‚¢</th>
          <th>ç›¸é–¢ä¿‚æ•° r</th>
          <th>å¼·ã•</th>
          <th>n</th>
        </tr>
      </thead>
      <tbody id="corrTableBody"></tbody>
    </table>
  </div>

</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ãƒ‡ãƒ¼ã‚¿ & è¨­å®š
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TABS = [
  { label: 'æ™‚é–“ Ã— Level',         xKey: 'total_hours', yKey: 'level',        xLabel: 'ãƒ­ã‚°ã‚¤ãƒ³æ™‚é–“ (h)', yLabel: 'Level' },
  { label: 'æ™‚é–“ Ã— ãƒ¬ãƒ“ãƒ¥ãƒ¼å›æ•°',   xKey: 'total_hours', yKey: 'review_given', xLabel: 'ãƒ­ã‚°ã‚¤ãƒ³æ™‚é–“ (h)', yLabel: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼å›æ•°' },
  { label: 'Level Ã— ãƒ¬ãƒ“ãƒ¥ãƒ¼å›æ•°',  xKey: 'level',       yKey: 'review_given', xLabel: 'Level',           yLabel: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼å›æ•°' },
];

let currentTab = 0;
let allStudents = [];
let passes = {};
let chartInstance = null;
let hasPassData = false;
let hasReviewData = false;
let searchLogin = '';   // æ¤œç´¢ä¸­ã®ãƒ­ã‚°ã‚¤ãƒ³å

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pearsonR(xs, ys) {
  const n = xs.length;
  if (n < 2) return 0;
  const mx = xs.reduce((a,b)=>a+b,0)/n;
  const my = ys.reduce((a,b)=>a+b,0)/n;
  const num = xs.reduce((s,x,i)=>s+(x-mx)*(ys[i]-my), 0);
  const den = Math.sqrt(xs.reduce((s,x)=>s+(x-mx)**2,0) * ys.reduce((s,y)=>s+(y-my)**2,0));
  return den === 0 ? 0 : num/den;
}

function linearRegLine(xs, ys) {
  const n = xs.length;
  const mx = xs.reduce((a,b)=>a+b,0)/n;
  const my = ys.reduce((a,b)=>a+b,0)/n;
  const slope = xs.reduce((s,x,i)=>s+(x-mx)*(ys[i]-my),0) / xs.reduce((s,x)=>s+(x-mx)**2,0);
  const intercept = my - slope*mx;
  return { slope, intercept };
}

function rColor(r) {
  const abs = Math.abs(r);
  if (abs >= 0.7) return '#00cec9';
  if (abs >= 0.4) return '#fdcb6e';
  return '#8888a0';
}

function rInterp(r) {
  const abs = Math.abs(r);
  const dir = r >= 0 ? 'æ­£' : 'è² ';
  if (abs >= 0.7) return { text: `å¼·ã„${dir}ã®ç›¸é–¢`, bg: '#00cec91a', color: '#00cec9' };
  if (abs >= 0.4) return { text: `ä¸­ç¨‹åº¦ã®${dir}ã®ç›¸é–¢`, bg: '#fdcb6e1a', color: '#fdcb6e' };
  if (abs >= 0.2) return { text: `å¼±ã„${dir}ã®ç›¸é–¢`, bg: '#a29bfe1a', color: '#a29bfe' };
  return { text: 'ã»ã¼ç›¸é–¢ãªã—', bg: '#8888a01a', color: '#8888a0' };
}

function baseColor(login) {
  if (!hasPassData) return 'rgba(108,92,231,0.75)';
  const p = passes[login];
  if (p === 'pass') return 'rgba(0,206,201,0.80)';
  if (p === 'fail') return 'rgba(255,118,117,0.80)';
  return 'rgba(136,136,160,0.55)';
}

function mean(arr) { return arr.reduce((a,b)=>a+b,0)/arr.length; }
function stddev(arr) {
  const m = mean(arr);
  return Math.sqrt(arr.reduce((s,v)=>s+(v-m)**2,0)/arr.length);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// æ¤œç´¢
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onSearch(val) {
  searchLogin = val.trim().toLowerCase();
  document.getElementById('searchClear').style.display = searchLogin ? 'block' : 'none';
  renderChart();   // ãƒãƒ£ãƒ¼ãƒˆã ã‘å†æç”»ï¼ˆHTMLã¯ç¶­æŒï¼‰
}

function clearSearch() {
  document.getElementById('searchInput').value = '';
  searchLogin = '';
  document.getElementById('searchClear').style.display = 'none';
  document.getElementById('searchResult').textContent = '';
  document.getElementById('searchResult').className = 'search-result';
  renderChart();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  const res = await fetch('data.json?' + Date.now());
  const d = await res.json();
  const all = [...(d.online || []), ...(d.offline || [])];
  const map = {};
  for (const s of all) map[s.login] = s;
  allStudents = Object.values(map);

  hasReviewData = allStudents.some(s => s.review_given != null && s.review_given > 0);

  try {
    const pr = await fetch('data/passes.json?' + Date.now());
    if (pr.ok) {
      passes = await pr.json();
      hasPassData = Object.keys(passes).length > 0;
    }
  } catch(_) {}

  document.getElementById('headerSub').textContent =
    `å…¨${allStudents.length}äºº` + (hasPassData ? ' Â· åˆå¦ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š' : '');

  buildAllCorrTable();
  render();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(i) {
  currentTab = i;
  document.querySelectorAll('.tab-btn').forEach((b,j)=>
    b.classList.toggle('active', i===j));
  render();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ãƒ•ãƒ«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆHTML + Chartï¼‰
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  const tab = TABS[currentTab];
  const reviewTab = (tab.xKey==='review_given'||tab.yKey==='review_given');

  let pts = allStudents.map(s => ({
    x: s[tab.xKey],
    y: s[tab.yKey],
    login: s.login,
  })).filter(p => p.x != null && p.y != null && !isNaN(p.x) && !isNaN(p.y));

  if (reviewTab && !hasReviewData) {
    document.getElementById('mainCard').innerHTML = `
      <div style="text-align:center;padding:60px 20px;color:var(--text-dim)">
        <div style="font-size:32px;margin-bottom:12px">â³</div>
        <div style="font-size:14px">ãƒ¬ãƒ“ãƒ¥ãƒ¼å›æ•°ãƒ‡ãƒ¼ã‚¿ã¯ã¾ã æ›´æ–°ä¸­ã§ã™</div>
        <div style="font-size:12px;margin-top:6px">æ¬¡ã®ãƒ‡ãƒ¼ã‚¿æ›´æ–°å¾Œï¼ˆæœ€å¤§1æ™‚é–“ï¼‰ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
      </div>`;
    return;
  }

  const xs = pts.map(p=>p.x);
  const ys = pts.map(p=>p.y);
  const r = pearsonR(xs, ys);
  const interp = rInterp(r);
  const reg = linearRegLine(xs, ys);

  const xMin = Math.min(...xs), xMax = Math.max(...xs);
  const yMin = Math.min(...ys), yMax = Math.max(...ys);
  const xMean = mean(xs), xStd = stddev(xs);
  const yMean = mean(ys), yStd = stddev(ys);
  const xPad = (xMax - xMin) * 0.05;
  const yPad = (yMax - yMin) * 0.05;

  document.getElementById('mainCard').innerHTML = `
    <div class="corr-header">
      <div class="corr-title">${tab.label}</div>
      <div class="r-badge">
        <div>
          <div style="font-size:10px;color:var(--text-dim);margin-bottom:2px">ç›¸é–¢ä¿‚æ•° r</div>
          <div class="r-value" style="color:${rColor(r)}">${r.toFixed(3)}</div>
        </div>
        <div class="r-interp" style="background:${interp.bg};color:${interp.color}">${interp.text}</div>
      </div>
    </div>
    <div class="chart-wrap"><canvas id="scatterCanvas"></canvas></div>
    <div class="mean-legend">
      <div class="mean-legend-item">
        <div class="mean-line-sample" style="border-color:#fdcb6e"></div>
        <span style="color:#fdcb6e">${tab.xLabel} å¹³å‡</span>
        <span style="font-weight:700;color:#fdcb6e;margin-left:2px">${xMean.toFixed(1)}</span>
      </div>
      <div class="mean-legend-item">
        <div class="mean-line-sample" style="border-color:#00cec9"></div>
        <span style="color:#00cec9">${tab.yLabel} å¹³å‡</span>
        <span style="font-weight:700;color:#00cec9;margin-left:2px">${yMean.toFixed(2)}</span>
      </div>
      <div class="mean-legend-item" style="margin-left:auto;color:var(--text-dim);font-size:10px">
        --- å›å¸°ç›´ç·š
      </div>
    </div>
    ${hasPassData ? `
    <div class="legend">
      <span><span class="legend-dot" style="background:#00cec9"></span>åˆæ ¼</span>
      <span><span class="legend-dot" style="background:#ff7675"></span>ä¸åˆæ ¼</span>
      <span><span class="legend-dot" style="background:#8888a0"></span>æœªç¢ºå®š</span>
    </div>` : ''}
    <div class="summary-grid">
      <div class="summary-item">
        <div class="summary-label">nï¼ˆå¯¾è±¡äººæ•°ï¼‰</div>
        <div class="summary-value">${pts.length}äºº</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">${tab.xLabel} å¹³å‡</div>
        <div class="summary-value highlight-x">${xMean.toFixed(1)}</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">${tab.yLabel} å¹³å‡</div>
        <div class="summary-value highlight-y">${yMean.toFixed(2)}</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">${tab.xLabel} æ¨™æº–åå·®</div>
        <div class="summary-value">${xStd.toFixed(1)}</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">${tab.yLabel} æ¨™æº–åå·®</div>
        <div class="summary-value">${yStd.toFixed(2)}</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">æ±ºå®šä¿‚æ•° rÂ²</div>
        <div class="summary-value">${(r*r).toFixed(3)}</div>
      </div>
    </div>`;

  // Chart ã‚’æç”»ï¼ˆå¤‰æ•°ã‚’ closure ã§æ¸¡ã™ï¼‰
  renderChart({ pts, xs, ys, xMin, xMax, yMin, yMax, xMean, yMean, xPad, yPad, reg, tab });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ãƒãƒ£ãƒ¼ãƒˆã®ã¿å†æç”»ï¼ˆæ¤œç´¢ãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨ï¼‰
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderChart(cached) {
  // cached ãŒãªã„å ´åˆã¯ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å†æ§‹ç¯‰
  if (!cached) {
    const tab = TABS[currentTab];
    const reviewTab = (tab.xKey==='review_given'||tab.yKey==='review_given');
    if (reviewTab && !hasReviewData) return;
    if (!document.getElementById('scatterCanvas')) return;

    const pts = allStudents.map(s => ({
      x: s[tab.xKey], y: s[tab.yKey], login: s.login,
    })).filter(p => p.x != null && p.y != null && !isNaN(p.x) && !isNaN(p.y));
    const xs = pts.map(p=>p.x), ys = pts.map(p=>p.y);
    const xMin = Math.min(...xs), xMax = Math.max(...xs);
    const yMin = Math.min(...ys), yMax = Math.max(...ys);
    const xMean = mean(xs), yMean = mean(ys);
    const xPad = (xMax - xMin)*0.05, yPad = (yMax - yMin)*0.05;
    const reg = linearRegLine(xs, ys);
    cached = { pts, xs, ys, xMin, xMax, yMin, yMax, xMean, yMean, xPad, yPad, reg, tab };
  }

  const { pts, xs, ys, xMin, xMax, yMin, yMax, xMean, yMean, xPad, yPad, reg, tab } = cached;

  // æ¤œç´¢ãƒãƒƒãƒåˆ¤å®š
  const hasSearch = searchLogin.length > 0;
  const matchedLogin = hasSearch
    ? (allStudents.find(s => s.login.toLowerCase() === searchLogin)?.login || null)
    : null;

  // æ¤œç´¢çµæœè¡¨ç¤ºæ›´æ–°
  const resultEl = document.getElementById('searchResult');
  if (hasSearch) {
    if (matchedLogin) {
      const s = allStudents.find(s => s.login === matchedLogin);
      const xVal = s[tab.xKey];
      const yVal = s[tab.yKey];
      resultEl.className = 'search-result found';
      resultEl.textContent = xVal != null && yVal != null
        ? `${matchedLogin}: ${Number(xVal).toFixed(1)} / ${Number(yVal).toFixed(2)}`
        : `${matchedLogin}: ãƒ‡ãƒ¼ã‚¿ãªã—`;
    } else {
      resultEl.className = 'search-result';
      resultEl.textContent = 'è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
    }
  } else {
    resultEl.className = 'search-result';
    resultEl.textContent = '';
  }

  // ç‚¹ã®è‰²ãƒ»ã‚µã‚¤ã‚ºã‚’æ±ºå®š
  const colors = pts.map(p => {
    if (matchedLogin && p.login === matchedLogin) return 'rgba(255,118,117,1)';  // èµ¤ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    if (hasSearch) return 'rgba(108,92,231,0.18)';  // ä»–ã¯è–„ã
    return baseColor(p.login);
  });
  const radii = pts.map(p =>
    (matchedLogin && p.login === matchedLogin) ? 10 : 5
  );
  const borders = pts.map(p =>
    (matchedLogin && p.login === matchedLogin) ? 'rgba(255,255,255,0.9)' : 'transparent'
  );
  const borderWidths = pts.map(p =>
    (matchedLogin && p.login === matchedLogin) ? 2 : 0
  );

  // å¹³å‡ç·šã®2ç‚¹ãšã¤ï¼ˆç¸¦ç·š: x=xMeanã€æ¨ªç·š: y=yMeanï¼‰
  const meanXLine = [
    { x: xMean, y: yMin - yPad },
    { x: xMean, y: yMax + yPad },
  ];
  const meanYLine = [
    { x: xMin - xPad, y: yMean },
    { x: xMax + xPad, y: yMean },
  ];
  // å›å¸°ç›´ç·š
  const regPts = [
    { x: xMin - xPad, y: reg.slope*(xMin-xPad) + reg.intercept },
    { x: xMax + xPad, y: reg.slope*(xMax+xPad) + reg.intercept },
  ];

  if (chartInstance) { chartInstance.destroy(); chartInstance = null; }

  const canvas = document.getElementById('scatterCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');

  chartInstance = new Chart(ctx, {
    type: 'scatter',
    data: {
      datasets: [
        // â‘  å­¦ç”Ÿã®ç‚¹ï¼ˆé€šå¸¸ or ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰
        {
          label: 'å­¦ç”Ÿ',
          data: pts.map(p=>({ x:p.x, y:p.y, login:p.login })),
          backgroundColor: colors,
          pointRadius: radii,
          pointHoverRadius: radii.map(r=>r+3),
          pointBorderColor: borders,
          pointBorderWidth: borderWidths,
          order: 3,
        },
        // â‘¡ Xè»¸å¹³å‡ç·šï¼ˆç¸¦ï¼‰
        {
          label: `${tab.xLabel} å¹³å‡: ${xMean.toFixed(1)}`,
          data: meanXLine,
          type: 'line',
          borderColor: 'rgba(253,203,110,0.7)',
          borderWidth: 1.5,
          borderDash: [4, 3],
          pointRadius: 0,
          fill: false,
          tension: 0,
          order: 2,
        },
        // â‘¢ Yè»¸å¹³å‡ç·šï¼ˆæ¨ªï¼‰
        {
          label: `${tab.yLabel} å¹³å‡: ${yMean.toFixed(2)}`,
          data: meanYLine,
          type: 'line',
          borderColor: 'rgba(0,206,201,0.7)',
          borderWidth: 1.5,
          borderDash: [4, 3],
          pointRadius: 0,
          fill: false,
          tension: 0,
          order: 2,
        },
        // â‘£ å›å¸°ç›´ç·š
        {
          label: 'å›å¸°ç›´ç·š',
          data: regPts,
          type: 'line',
          borderColor: 'rgba(162,155,254,0.5)',
          borderWidth: 1.5,
          borderDash: [6, 4],
          pointRadius: 0,
          fill: false,
          tension: 0,
          order: 1,
        },
      ],
    },
    options: {
      animation: { duration: 200 },
      responsive: true,
      maintainAspectRatio: false,
      onClick(event, elements) {
        // å­¦ç”Ÿã®ç‚¹ï¼ˆdataset index 0ï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰å€‹äººãƒšãƒ¼ã‚¸ã¸
        const el = elements.find(e => e.datasetIndex === 0);
        if (el) {
          const login = pts[el.index].login;
          window.location.href = `${login}.html`;
        }
      },
      onHover(event, elements) {
        const el = elements.find(e => e.datasetIndex === 0);
        event.native.target.style.cursor = el ? 'pointer' : 'default';
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          filter(item) { return item.datasetIndex === 0; },  // å­¦ç”Ÿç‚¹ã®ã¿tooltip
          callbacks: {
            label(ctx) {
              const d = ctx.raw;
              if (!d.login) return '';
              return ` ${d.login}  (${tab.xLabel}: ${Number(d.x).toFixed(1)}, ${tab.yLabel}: ${Number(d.y).toFixed(2)})  â† ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°`;
            },
          },
          backgroundColor: '#1a1a24',
          borderColor: '#2a2a3a',
          borderWidth: 1,
          titleColor: '#a29bfe',
          bodyColor: '#e8e8f0',
          padding: 10,
        },
      },
      scales: {
        x: {
          title: { display: true, text: tab.xLabel, color: '#8888a0', font: { size: 12 } },
          grid: { color: '#2a2a3a' },
          ticks: { color: '#8888a0' },
          min: xMin - xPad,
          max: xMax + xPad,
        },
        y: {
          title: { display: true, text: tab.yLabel, color: '#8888a0', font: { size: 12 } },
          grid: { color: '#2a2a3a' },
          ticks: { color: '#8888a0' },
          min: yMin - yPad,
          max: yMax + yPad,
        },
      },
    },
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// å…¨ãƒšã‚¢ç›¸é–¢ãƒ†ãƒ¼ãƒ–ãƒ«
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildAllCorrTable() {
  const tbody = document.getElementById('corrTableBody');
  tbody.innerHTML = '';

  TABS.forEach((tab, i) => {
    const pts = allStudents.map(s=>({
      x: s[tab.xKey], y: s[tab.yKey],
    })).filter(p=>p.x!=null&&p.y!=null&&!isNaN(p.x)&&!isNaN(p.y));

    const reviewTab = (tab.xKey==='review_given'||tab.yKey==='review_given');
    if (reviewTab && !hasReviewData) {
      tbody.innerHTML += `<tr onclick="switchTab(${i})">
        <td>${tab.label}</td>
        <td style="color:var(--text-dim)">â€”</td>
        <td style="color:var(--text-dim);font-size:11px">ãƒ‡ãƒ¼ã‚¿æ›´æ–°å¾…ã¡</td>
        <td style="color:var(--text-dim)">â€”</td>
      </tr>`;
      return;
    }

    const xs = pts.map(p=>p.x), ys = pts.map(p=>p.y);
    const r = pearsonR(xs, ys);
    const interp = rInterp(r);
    tbody.innerHTML += `<tr onclick="switchTab(${i})">
      <td>${tab.label}</td>
      <td style="font-weight:700;color:${rColor(r)}">${r.toFixed(3)}</td>
      <td><span style="font-size:11px;color:${interp.color}">${interp.text}</span></td>
      <td style="color:var(--text-dim)">${pts.length}</td>
    </tr>`;
  });

  document.getElementById('allCorrTable').style.display = 'block';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// èµ·å‹•
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadData().catch(e => {
  document.getElementById('mainCard').innerHTML =
    `<div class="loading" style="color:var(--red)">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
});
</script>
</body>
</html>
