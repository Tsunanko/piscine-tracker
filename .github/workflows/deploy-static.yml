name: Deploy Static Pages
# ───────────────────────────────────────────────────────────────────────────
# このワークフローの役割:
#   main ブランチへの push 時に HTML/JS/CSS/Python のコード変更を
#   即座に GitHub Pages へデプロイする。
#
# 【重要】データと分離した理由:
#   - main ブランチ: コード（HTML/JS/Python）のみ。データ(*.json)は含まない
#   - gh-pages ブランチ: update-data.yml が書き込むデータ(*.json)が存在する
#
#   もしデータ復元ステップがないと:
#     git push（コード変更）→ main のコードのみが gh-pages に上書き
#     → gh-pages の data.json が消える → サイトにデータが表示されない！
#
#   そのため "Restore latest data from gh-pages" で gh-pages から最新の
#   data.json と data/*.json を復元してからデプロイする。
# ───────────────────────────────────────────────────────────────────────────

on:
  push:
    branches: [main]  # main ブランチへの push のみトリガー

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # ─── Step 1: リポジトリをチェックアウト ──────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ─── Step 2: gh-pages ブランチから最新データを復元 ───────────────
      # 【なぜこの処理が必要か】
      # main ブランチには data.json / data/*.json がない（コードのみ）。
      # gh-pages ブランチには update-data.yml が書き込んだ最新 JSON がある。
      # このステップで gh-pages から data を取ってきて public/ に配置する。
      # → コード変更でデータが消えないようにする。
      #
      # git fetch origin gh-pages || true
      #   → gh-pages ブランチ情報を取得（存在しない場合もエラーにしない）
      #
      # git show origin/gh-pages:data.json > public/data.json
      #   → gh-pages ブランチの data.json を直接ファイルに書き出す
      #   → 2>/dev/null でエラー出力を隠す（ファイルがない場合のエラーを無視）
      #
      # git archive origin/gh-pages data/ | tar -x -C public/
      #   → gh-pages ブランチの data/ ディレクトリ全体を tar アーカイブして
      #      public/ に展開する（data/*.json を一括復元）
      - name: Restore latest data from gh-pages
        run: |
          git fetch origin gh-pages || true
          git show origin/gh-pages:data.json > public/data.json 2>/dev/null \
            && echo "data.json restored from gh-pages" \
            || echo "No data.json on gh-pages yet, using existing"
          mkdir -p public/data
          git archive origin/gh-pages data/ 2>/dev/null \
            | tar -x -C public/ \
            && echo "data/*.json restored from gh-pages" \
            || echo "No data/ on gh-pages yet, using existing"

      # ─── Step 3: GitHub Pages へデプロイ ─────────────────────────────
      # コード（HTML/JS/CSS）+ 復元したデータ（JSON）を合わせて gh-pages にデプロイ
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          force_orphan: false
